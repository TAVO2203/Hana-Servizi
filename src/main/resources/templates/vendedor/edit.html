<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hana Servizi</title>
  <link rel="icon" type="image" th:href="@{/img/icon.png}">
  <link rel="stylesheet" th:href="@{/CSS/productosEdit.css}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<header class="header">
  <div class="header_container">
    <div class="bars">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
    <div class="logo">
      <img th:src="@{/img/icon.png}" alt="Logo De HanaServizi" class="logo-img">
      <h2 class="name-project"> HanaServizi</h2>
    </div>
    <nav class="nav-menu">
      <a th:href="${rolUsuario == 'ROLE_VENDEDOR'} ? @{/vendedor/dashboard} : @{/cliente/dashboard}"
         class="btn-icon"
         th:if="${nombreUsuario != null}">
        <i class="fa-solid fa-user"></i>
      </a>
      <a href="#" class="btn-icon"><i class="fa-solid fa-bell"></i></a>
      <button id="toggle-dark-mode" class="modo-btn">
        <i class="fa-solid fa-moon"></i>
        <span class="modo-text">Modo Oscuro</span>
      </button>
    </nav>
  </div>
</header>
<section>
  <div class="container">
    <h1>Actualizar Producto</h1>

    <form th:action="@{/vendedor/productos/editar}"
          th:object="${productoDto}"
          method="POST"
          enctype="multipart/form-data">

      <input type="hidden" th:field="*{id}" />

      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre</label>
        <input type="text" id="nombre"
               th:field="*{nombre}"
               class="form-control"
               th:classappend="${#fields.hasErrors('nombre')} ? ' input-rojo' : ''"
               placeholder="Nombre del producto">
        <p th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="text-danger"></p>
      </div>

      <div class="mb-3">
        <label for="precio" class="form-label">Precio</label>
        <input type="number" id="precio"
               th:field="*{precio}"
               class="form-control"
               th:classappend="${#fields.hasErrors('precio')} ? ' input-rojo' : ''"
               step="0.01"
               placeholder="Precio">
        <p th:if="${#fields.hasErrors('precio')}" th:errors="*{precio}" class="text-danger"></p>
      </div>

      <div class="mb-3">
        <label for="fecha_agregacion" class="form-label">Fecha de Agregación</label>
        <input type="date" id="fecha_agregacion"
               th:field="*{fechaAgregacion}"
               class="form-control"
               th:classappend="${#fields.hasErrors('fechaAgregacion')} ? ' input-rojo' : ''">
        <p th:if="${#fields.hasErrors('fechaAgregacion')}" th:errors="*{fechaAgregacion}" class="text-danger"></p>
      </div>

      <div class="mb-3">
        <label for="estadoProducto" class="form-label">Estado del Producto</label>
        <select id="estadoProducto"
                th:field="*{estadoProducto}"
                class="form-select"
                th:classappend="${#fields.hasErrors('estadoProducto')} ? ' input-rojo' : ''">
          <option value="">Seleccione un estado</option>
          <option value="Disponible">Disponible</option>
          <option value="No disponible">No disponible</option>
        </select>
        <p th:if="${#fields.hasErrors('estadoProducto')}" th:errors="*{estadoProducto}" class="text-danger"></p>
      </div>

      <div class="mb-3">
        <label for="descripcion" class="form-label">Descripción</label>
        <textarea id="descripcion"
                  th:field="*{descripcion}"
                  class="form-control"
                  th:classappend="${#fields.hasErrors('descripcion')} ? ' input-rojo' : ''"
                  placeholder="Descripción del producto"></textarea>
        <p th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}" class="text-danger"></p>
      </div>

      <div class="mb-3">
        <label for="nombreMarca" class="form-label">Marca</label>
        <input type="text" id="nombreMarca"
               th:field="*{nombreMarca}"
               class="form-control"
               th:classappend="${#fields.hasErrors('nombreMarca')} ? ' input-rojo' : ''"
               placeholder="Marca">
        <p th:if="${#fields.hasErrors('nombreMarca')}" th:errors="*{nombreMarca}" class="text-danger"></p>
      </div>

      <div class="mb-3">
        <label for="categoriaId" class="form-label">Categoría</label>
        <select id="categoriaId"
                th:field="*{categoriaId}"
                class="form-select"
                th:classappend="${#fields.hasErrors('categoriaId')} ? ' input-rojo' : ''">
          <option value="">Selecciona una categoría</option>
          <option th:each="cat : ${categorias}"
                  th:value="${cat.id}"
                  th:text="${cat.nombreCategoria}">
          </option>
        </select>
        <p th:if="${#fields.hasErrors('categoriaId')}" th:errors="*{categoriaId}" class="text-danger"></p>
      </div>

        <!-- Stock general visible solo si no hay tallas -->
        <div class="mb-3" th:if="${#lists.isEmpty(productoDto.tallas)}">
            <label for="stockVisible" class="form-label">Stock General</label>
            <input type="number" id="stockVisible"
                   class="form-control"
                   th:value="*{stock}"
                   min="0"
                   oninput="sincronizarStockGeneral()">
            <p th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}" class="text-danger"></p>
        </div>

        <!-- Tallas con stocks -->
        <div th:if="${!#lists.isEmpty(productoDto.tallas)}">
            <label class="form-label">Tallas y Stock</label>
            <div id="tallasContainer">
                <div th:each="talla, iterStat : *{tallas}" class="d-flex mb-2">
                    <input type="text" th:field="*{tallas[__${iterStat.index}__].talla}"
                           class="form-control me-2" placeholder="Talla (ej. M)">
                    <input type="number" th:field="*{tallas[__${iterStat.index}__].stock}"
                           class="form-control stock-talla" placeholder="Stock"
                           oninput="calcularStockGeneral()">
                </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="agregarTalla()">+ Añadir talla</button>
        </div>

        <!-- Campo oculto SIEMPRE presente -->
        <input type="hidden" id="stockHidden" th:field="*{stock}" />

        <div class="mb-3">
        <label for="nuevaImagen" class="form-label">Carga una nueva imagen (opcional)</label>
        <input type="file" id="nuevaImagen"
               th:field="*{nuevaImagen}"
               class="form-control"
               th:classappend="${#fields.hasErrors('nuevaImagen')} ? ' input-rojo' : ''"
               accept="image/*">
        <p th:if="${#fields.hasErrors('nuevaImagen')}" th:errors="*{nuevaImagen}" class="text-danger"></p>
      </div>

      <button type="submit" class="btn btn-primary">Actualizar</button>
      <a th:href="@{/vendedor/productos}" class="btn btn-success w-100 mt-2">Volver</a>
    </form>
  </div>
</section>

<footer>
  <div class="footer-col">
    <h4>Nuestras Redes</h4>
    <div class="links">
      <a href="#"><i class="fa-brands fa-facebook"></i></a>
      <a href="#"><i class="fa-brands fa-instagram"></i></a>
      <a href="#"><i class="fa-brands fa-tiktok"></i></a>
    </div>
  </div>
  <div class="footer-col">
    <h4> Acerca De Hana Servizi</h4>
    <ul>
      <li> <a href="#">Sobre Nosotros</a></li>
      <li> <a href="#">Nuestras Políticas</a></li>
      <li> <a href="#">Términos De Servicio</a></li>
      <li> <a href="#">Políticas De Privacidad</a></li>
      <li> <a href="#">Políticas De Reembolsos y Devoluciones</a></li>
    </ul>
  </div>
  <div class="footer-col">
    <h4> Contacto </h4>
    <ul class="info">
      <li>
        <span><i class="fa-solid fa-phone"></i></span><p>+57 123 4567 890</p>
      </li>
      <li>
        <span><i class="fa-solid fa-envelope"></i></span><p>hanaservizi@gmail.com</p>
      </li>
    </ul>
  </div>
  <div class="footer-col">
    <h4> Métodos De Pago</h4>
    <ul>
      <img th:src="@{/img/pay.png}" alt="Logo">
      <img class="img3" th:src="@{/img/nequi.webp}" alt="">
    </ul>
  </div>
</footer>
<div class="copyright">
  <p>©2024 HanaServizi. ALL Rights Reserved.</p>
</div>
<script th:src="@{/JS/cambioColor.js}" defer></script>
<script>
    function agregarTalla() {
        const container = document.getElementById("tallasContainer");
        const index = container.children.length;
        const row = document.createElement("div");
        row.classList.add("row", "mb-2");

        row.innerHTML = `
    <div class="col">
      <input type="text"
             name="tallas[${index}].talla"
             class="form-control"
             placeholder="Talla (ej: S, M, L)">
    </div>
    <div class="col">
      <input type="number"
             name="tallas[${index}].stock"
             class="form-control stock-talla"
             placeholder="Stock por talla"
             min="0"
             value="0"
             oninput="calcularStockGeneral()">
    </div>
  `;

        container.appendChild(row);
    }

    function calcularStockGeneral() {
        let total = 0;
        document.querySelectorAll(".stock-talla").forEach(input => {
            total += parseInt(input.value || 0);
        });
        document.getElementById("stockHidden").value = total;
    }

    // 👉 Si el producto no tiene tallas, sincronizamos visible ↔ hidden
    function sincronizarStockGeneral() {
        const stockVisible = document.getElementById("stockVisible");
        if (stockVisible) {
            document.getElementById("stockHidden").value = stockVisible.value;
        }
    }

    // 👉 Al cargar la página calculamos o sincronizamos según el caso
    document.addEventListener("DOMContentLoaded", () => {
        if (document.querySelectorAll(".stock-talla").length > 0) {
            calcularStockGeneral();
        } else {
            sincronizarStockGeneral();
        }
    });

</script>

</body>
</html>